<!DOCTYPE html>
<!--
  ~ Copyright 2014 Thierry Wasylczenko
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~   http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<html>
<head>
    <title>SlideShowFX chat</title>

    <meta name="viewport" content="width=device-width, height=device-height, user-scalable=no">

    <script type="text/javascript">
        var socket;

        function getAttendeeNameFromCookie() {
            // Check the cookie if it exists and update display
            var cookieName = "attendeeName=";
            var cookies =  document.cookie.split(';');

            for(var index = 0; index < cookies.length; index++) {
                var c = cookies[index].trim();

                if (c.indexOf(cookieName) == 0) {
                   return c.substring(cookieName.length, c.length);
                }
            }

            return "";
        }

        window.onload = function() {
            // Check the cookie if it exists and update display
            var attendeeName = getAttendeeNameFromCookie();

            if(attendeeName != "") {
                document.getElementById("connection-form").style.display = "none";
                document.getElementById("chat").style.display = "block";
            }

            socket = new WebSocket("ws://${slideshowfx_server_ip}:${slideshowfx_server_port}/slideshowfx/chat/attendee");

            socket.onopen = function(event) {
            };

            socket.onclose = function(event) {
                var messagesDiv = document.getElementById("messages");

                messagesDiv.innerHTML = messagesDiv.innerHTML + "<div class=\"chat-ended\">Chat has ended</div>";
                document.getElementById("send-form").style.display = "none";
            };

            socket.onmessage = function(event) {
                var messagesDiv = document.getElementById("messages");

                var json = JSON.parse(event.data);

                if(undefined != json.message) {

                    var htmlMessage = document.getElementById(json.message.id);

                    // New message
                    if(undefined == htmlMessage) {
                        htmlMessage = "<div class=\"chat-message\" id=\"" + json.message.id + "\">"
                                    + "<div id=\"" + json.message.id + "-check\" style=\"display: none; margin-right: 5px;\"><img src=\"http://${slideshowfx_server_ip}:${slideshowfx_server_port}/slideshowfx/chat/images/check.png\" width=\"10px\" /></div>"
                                    + "<span class=\"author\">" + json.message.author + " ";

                        if( json.message.author == "I") {
                            htmlMessage = htmlMessage + "say";
                        } else {
                            htmlMessage = htmlMessage + "said";
                        }

                        htmlMessage = htmlMessage + " :" + "</span><br />"
                                    + "<span class=\"message-content\">" + decodeURIComponent(escape(window.atob(json.message.content))) + "</span></div>";

                        messagesDiv.innerHTML = messagesDiv.innerHTML + htmlMessage;

                        updateMessage(json);
                    }
                    // Existing message : update it
                    else {
                        updateMessage(json);
                    }
                }
            }
        };

        function updateMessage(json) {
            var htmlMessage = document.getElementById(json.message.id);

            if("answered" == json.message.status) {
                htmlMessage.className += " " + "question-answered";

                var imageDiv = document.getElementById(json.message.id + "-check");
                imageDiv.style.display = "inline";
            }
        }

        function sendMessage() {
            var attendeeMessage = document.getElementById("attendee-message-textarea").value;

            if(attendeeMessage === "") {
                alert("Enter a message");
            } else {
                var attendeeName = getAttendeeNameFromCookie();

                if(attendeeName === "") {
                    attendeeName = "somebody";
                }
                var jsonMessage = "{ \"message\" : { \"author\": \"" + attendeeName + "\", \"content\": \"" + window.btoa(unescape(encodeURIComponent(attendeeMessage))) + "\"} }";

                socket.send(jsonMessage);

                document.getElementById("attendee-message-textarea").value = "";
            }
        }

        function connectUser() {
            var attendeeName = document.getElementById("attendee-name-text").value;
            document.cookie = "attendeeName=" + attendeeName;

            document.getElementById("connection-form").style.display = "none";
            document.getElementById("chat").style.display = "block";
        }
    </script>

    <style type="text/css">
        #connection-form {
            border-radius: 8px;
            background-color: darkgray;
            float: left;
            width: 520px;
            text-align: center;
        }
        #attendee-name-text, #attendee-name-text:focus {
            border-radius: 15px;
            color: black;
            border: none;
            padding: 8px;
            width: 480px;
            margin: 10px;

            background-image: -webkit-linear-gradient(top, gray 0%, lightgray 100%);
            background-image:    -moz-linear-gradient(top, gray 0%, lightgray 100%);
            background-image:     -ms-linear-gradient(top, gray 0%, lightgray 100%);
            background-image:      -o-linear-gradient(top, gray 0%, lightgray 100%);
            background-image:         linear-gradient(top, gray 0%, lightgray 100%);
        }
        #attendee-name-text::-webkit-input-placeholder {
            color:    black;
        }
        #attendee-name-text:-moz-placeholder {
            color:    black;
        }
        #attendee-name-text:-ms-input-placeholder{
            color:    black;
        }
        #attendee-name-text::-moz-placeholder {
            color:    black;
        }
        .connect-button {
            color: white;
            border-radius: 8px;
            border: none;
            padding: 8px;
            width: 500px;
            margin: 10px;

            background-image: -webkit-linear-gradient(top, green 0%, darkgreen 100%);
            background-image:    -moz-linear-gradient(top, green 0%, darkgreen 100%);
            background-image:     -ms-linear-gradient(top, green 0%, darkgreen 100%);
            background-image:      -o-linear-gradient(top, green 0%, darkgreen 100%);
            background-image:         linear-gradient(top, green 0%, darkgreen 100%);
        }
        #chat {
            border-radius: 8px;
            background-color: lightgray;
            border: 1px solid gray;
            width: 520px;
            padding: 5px;
        }
        #messages {
            margin-bottom: 5px;
        }
        #attendee-message-textarea {
            width: 500px;
        }
        #send-message-button {
            color: white;
            border-radius: 8px;
            border: none;
            width: 500px;
            height: 30px;
            margin-top: 10px;

            background-image: -webkit-linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
            background-image:    -moz-linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
            background-image:     -ms-linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
            background-image:      -o-linear-gradienttop, #81BEF7 0%, #2E9AFE 100%);
            background-image:         linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
        }
        .chat-message {
            background-color: white;
            padding: 5px;
            margin: 3px;
        }
        .question-answered {
            background-color: #D0F5A9;
        }
        .author {
            font-weight: bold;
        }
        .message-content {
            font-style: italic;
        }
        .chat-ended {
            font-style: italic;
            text-align: center;
        }

        @media screen and (-webkit-min-device-pixel-ratio: 1.0) and (min-resolution: 2.0dppx),
               screen and (-webkit-min-device-pixel-ratio: 1.3),
               screen and (-webkit-min-device-pixel-ratio: 1.5),
               screen and (-webkit-min-device-pixel-ratio: 2.0),
               screen and (-webkit-min-device-pixel-ratio: 3.0) {
            body {
                margin: 0;
                width: 100%;
            }
            #connection-form {
                border-radius: 0px;
                background-color: darkgray;
                float: left;
                width: 100%;
                text-align: center;
            }
            #attendee-name-text, #attendee-name-text:focus {
                width: 90%;
            }
            .connect-button {
                width: 95%;
            }
            #chat {
                margin: auto;
                text-align: center;
                border-radius: 0px;
                background-color: lightgray;
                border: 1px solid gray;
                width: auto;
                height: 100%;
                padding: 5px;
            }
            #messages {
                overflow-y: auto;
                width: 98%;
                height: 20%;
                margin-bottom: 5px;
            }
            #attendee-message-textarea {
                width: 95%;
            }
            #send-message-button {
                color: white;
                border-radius: 8px;
                border: none;
                width: 95%;
                height: 30px;
                margin-top: 10px;
                bottom: 0px;

                background-image: -webkit-linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
                background-image:    -moz-linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
                background-image:     -ms-linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
                background-image:      -o-linear-gradienttop, #81BEF7 0%, #2E9AFE 100%);
                background-image:         linear-gradient(top, #81BEF7 0%, #2E9AFE 100%);
            }
            .chat-message {
                width: 100%;
                background-color: white;
                background-color: white;
                padding: 5px;
                margin: 3px;
                text-align: justify;
            }
        }

    </style>
</head>
<body>
    <div id="connection-form">
        <input type="text" id="attendee-name-text" placeholder="Enter your name">
        <button class="connect-button" onclick="javascript:connectUser();">Connect</button>
    </div>

    <div id="chat" style="display:none;">
        <div id="messages"></div>
        <div id="send-form">
            <p>
                <textarea id="attendee-message-textarea" rows="5" placeholder="Message"></textarea><br />
                <button onclick="javascript:sendMessage();" id="send-message-button">Send</button>
            </p>
        </div>
    </div>

</body>
</html>